*[Русская версия](v070-to-v080.ru.md)*

# Migration from v0.7.0 to v0.8.0

Go SDK migration guide for the v0.8.0 release.

> This release affects **all SDKs**. Go SDK moves from v0.7.0 to v0.8.0.
> Java, Python, and C# SDKs move from v0.6.0 to v0.8.0
> (see [v0.6.0 to v0.8.0](v060-to-v080.md)).

## What Changed

New LDAP health checker with full protocol support:

| Feature | Description |
| --- | --- |
| Check methods | `anonymous_bind`, `simple_bind`, `root_dse` (default), `search` |
| Protocols | `ldap://` (port 389), `ldaps://` (port 636), StartTLS |
| TLS options | `startTLS`, `tlsSkipVerify` |
| Pool mode | Accept existing `*ldap.Conn` for health checks |

---

## Do I Need to Change My Code?

**No.** This is a fully backward-compatible release. All existing code
continues to work without modification.

---

## New Feature: LDAP Health Checker

### Basic Usage

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth"
    _ "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
)

dh, _ := dephealth.New("my-service", "my-team",
    dephealth.LDAP("directory",
        dephealth.FromURL("ldap://ldap.svc:389"),
        dephealth.Critical(true),
    ),
)
```

### Check Methods

```go
// Anonymous bind
dephealth.LDAP("ldap",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("anonymous_bind"),
)

// Simple bind with credentials
dephealth.LDAP("ad",
    dephealth.FromURL("ldaps://ad.corp:636"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("simple_bind"),
    dephealth.WithLDAPBindDN("cn=monitor,dc=corp,dc=com"),
    dephealth.WithLDAPBindPassword("secret"),
)

// RootDSE query (default)
dephealth.LDAP("openldap",
    dephealth.FromURL("ldap://openldap.svc:389"),
    dephealth.Critical(false),
)

// Search
dephealth.LDAP("directory",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("search"),
    dephealth.WithLDAPBaseDN("dc=example,dc=com"),
    dephealth.WithLDAPSearchFilter("(objectClass=organizationalUnit)"),
    dephealth.WithLDAPSearchScope("one"),
)
```

### StartTLS

```go
dephealth.LDAP("ldap-starttls",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPStartTLS(true),
    dephealth.WithLDAPTLSSkipVerify(true), // optional: skip cert verification
)
```

### Pool Mode

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
    ldaplib "github.com/go-ldap/ldap/v3"
)

conn, _ := ldaplib.DialURL("ldap://ldap.svc:389")
checker := ldapcheck.New(ldapcheck.WithConn(conn))
```

### Selective Import

Import only the LDAP checker to minimize binary size:

```go
import _ "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
```

### Error Classification

| Condition | Status | Detail |
| --- | --- | --- |
| Check succeeded | `ok` | `ok` |
| LDAP code 49 (Invalid Credentials) | `auth_error` | `auth_error` |
| LDAP code 50 (Insufficient Access Rights) | `auth_error` | `auth_error` |
| TLS/StartTLS failure | `tls_error` | `tls_error` |
| Connection refused | `connection_error` | `connection_refused` |
| DNS resolution failed | `dns_error` | `dns_error` |
| Timeout | `timeout` | `timeout` |
| Server down/busy/unavailable | `unhealthy` | `unhealthy` |

### Configuration Validation

| Condition | Error |
| --- | --- |
| `simple_bind` without `bindDN` + `bindPassword` | Config error |
| `search` without `baseDN` | Config error |
| `startTLS=true` with `ldaps://` | Config error (incompatible) |
