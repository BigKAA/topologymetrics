*[Русская версия](v042-to-v050.ru.md)*

# Migration from v0.4.x to v0.5.0

Cross-SDK migration guide for the v0.5.0 release.

## Breaking Change: Mandatory `group` Parameter

v0.5.0 adds a **mandatory `group` parameter** to all SDK constructors. The `group`
represents a logical grouping of the service (team, subsystem, project), enabling
dephealth-ui to group services by logical membership rather than physical location
(Kubernetes namespace).

If `group` is missing in both the API call and the `DEPHEALTH_GROUP` environment
variable, the SDK will **fail to start** with a clear error message.

---

## Migration Steps by SDK

### Go

```go
// v0.4.x
dh, err := dephealth.New("order-api",
    dephealth.Postgres("postgres-main", ...),
)

// v0.5.0
dh, err := dephealth.New("order-api", "billing-team",
    dephealth.Postgres("postgres-main", ...),
)
```

### Java (programmatic)

```java
// v0.4.x
DepHealth dh = DepHealth.builder("order-api", meterRegistry)

// v0.5.0
DepHealth dh = DepHealth.builder("order-api", "billing-team", meterRegistry)
```

### Java (Spring Boot YAML)

```yaml
# v0.4.x
dephealth:
  name: order-api
  dependencies: ...

# v0.5.0
dephealth:
  name: order-api
  group: billing-team
  dependencies: ...
```

### Python

```python
# v0.4.x
dh = DependencyHealth("order-api",
    postgres_check("postgres-main", ...),
)

# v0.5.0
dh = DependencyHealth("order-api", "billing-team",
    postgres_check("postgres-main", ...),
)
```

### C\#

```csharp
// v0.4.x
var dh = DepHealthMonitor.CreateBuilder("order-api")

// v0.5.0
var dh = DepHealthMonitor.CreateBuilder("order-api", "billing-team")
```

---

## Environment Variable

Add `DEPHEALTH_GROUP` to your deployment configuration. Precedence is the same
as for `DEPHEALTH_NAME`: API argument > environment variable.

```bash
DEPHEALTH_NAME=order-api
DEPHEALTH_GROUP=billing-team
```

If `group` is missing in both the API call and the environment variable, the SDK
will fail to start with a clear error message.

---

## Metric Output Change

All metrics now include the `group` label:

```text
# v0.4.x
app_dependency_health{name="order-api",dependency="postgres-main",type="postgres",host="pg.svc",port="5432",critical="yes"} 1

# v0.5.0
app_dependency_health{name="order-api",group="billing-team",dependency="postgres-main",type="postgres",host="pg.svc",port="5432",critical="yes"} 1
```

Label order: `name`, `group`, `dependency`, `type`, `host`, `port`, `critical`, `[custom]`.

---

## PromQL Query Impact

If your PromQL queries use `by()` clauses, you may need to add `group`:

```promql
# v0.4.x
sum by (name, dependency) (app_dependency_health)

# v0.5.0 — add group if needed for grouping
sum by (name, group, dependency) (app_dependency_health)
```

Existing queries **without** `by()` clauses will continue to work — the `group`
label is simply an additional label.

---

## Validation Rules

The `group` value follows the same rules as `name`:

| Rule | Value |
| --- | --- |
| Format | `[a-z][a-z0-9-]*` |
| Length | 1-63 characters |
| First character | lowercase letter |

---

## Kubernetes Deployment

Add `DEPHEALTH_GROUP` to your Helm values or Kubernetes manifests:

```yaml
env:
  - name: DEPHEALTH_GROUP
    value: "billing-team"
```
