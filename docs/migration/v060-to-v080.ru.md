*[English version](v060-to-v080.md)*

# Миграция с v0.6.0 на v0.8.0

Руководство по миграции Java, Python и C# SDK с v0.6.0 на v0.8.0.

> Для миграции Go SDK с v0.7.0 на v0.8.0 см.
> [v0.7.0 → v0.8.0](v070-to-v080.ru.md).

## Что изменилось

Новый LDAP-чекер с полной поддержкой протокола добавлен во все SDK:

| Возможность | Описание |
| --- | --- |
| Методы проверки | `anonymous_bind`, `simple_bind`, `root_dse` (по умолчанию), `search` |
| Протоколы | `ldap://` (порт 389), `ldaps://` (порт 636), StartTLS |
| TLS-опции | `startTLS`, `tlsSkipVerify` |
| Режим пула | Принимает существующее LDAP-соединение для проверок |

---

## Нужно ли менять код?

**Нет.** Это полностью обратно совместимый релиз. Весь существующий код
продолжает работать без изменений.

---

## Новая возможность: LDAP-чекер

### Java

```java
import biz.kryukov.dev.dephealth.checks.LdapHealthChecker;
import biz.kryukov.dev.dephealth.checks.LdapHealthChecker.CheckMethod;

// Запрос RootDSE (по умолчанию)
var checker = LdapHealthChecker.builder()
    .checkMethod(CheckMethod.ROOT_DSE)
    .build();

// Простая привязка с учётными данными через LDAPS
var checker = LdapHealthChecker.builder()
    .checkMethod(CheckMethod.SIMPLE_BIND)
    .bindDN("cn=monitor,dc=corp,dc=com")
    .bindPassword("secret")
    .useTLS(true)
    .build();

// Поиск с StartTLS
var checker = LdapHealthChecker.builder()
    .checkMethod(CheckMethod.SEARCH)
    .baseDN("dc=example,dc=com")
    .searchFilter("(objectClass=organizationalUnit)")
    .searchScope(LdapHealthChecker.LdapSearchScope.ONE)
    .startTLS(true)
    .build();
```

### Python

```python
from dephealth.checks.ldap import LdapChecker, LdapCheckMethod, LdapSearchScope

# Запрос RootDSE (по умолчанию)
checker = LdapChecker(check_method=LdapCheckMethod.ROOT_DSE)

# Простая привязка с учётными данными через LDAPS
checker = LdapChecker(
    check_method=LdapCheckMethod.SIMPLE_BIND,
    bind_dn="cn=monitor,dc=corp,dc=com",
    bind_password="secret",
    use_tls=True,
)

# Поиск с StartTLS
checker = LdapChecker(
    check_method=LdapCheckMethod.SEARCH,
    base_dn="dc=example,dc=com",
    search_filter="(objectClass=organizationalUnit)",
    search_scope=LdapSearchScope.ONE,
    start_tls=True,
)
```

### C\#

```csharp
using DepHealth.Checks;

// Запрос RootDSE (по умолчанию)
var checker = new LdapChecker(checkMethod: LdapCheckMethod.RootDse);

// Простая привязка с учётными данными через LDAPS
var checker = new LdapChecker(
    checkMethod: LdapCheckMethod.SimpleBind,
    bindDN: "cn=monitor,dc=corp,dc=com",
    bindPassword: "secret",
    useTls: true);

// Поиск с StartTLS
var checker = new LdapChecker(
    checkMethod: LdapCheckMethod.Search,
    baseDN: "dc=example,dc=com",
    searchFilter: "(objectClass=organizationalUnit)",
    searchScope: LdapSearchScope.One,
    startTls: true);
```

---

## Классификация ошибок

Все SDK классифицируют ошибки LDAP единообразно:

| Условие | Статус | Детализация |
| --- | --- | --- |
| Проверка прошла успешно | `ok` | `ok` |
| LDAP код 49 (Invalid Credentials) | `auth_error` | `auth_error` |
| LDAP код 50 (Insufficient Access Rights) | `auth_error` | `auth_error` |
| Ошибка TLS/StartTLS | `tls_error` | `tls_error` |
| Соединение отклонено | `connection_error` | `connection_refused` |
| Ошибка DNS-разрешения | `dns_error` | `dns_error` |
| Тайм-аут | `timeout` | `timeout` |
| Сервер недоступен/занят | `unhealthy` | `unhealthy` |

---

## Валидация конфигурации

| Условие | Ошибка |
| --- | --- |
| `simple_bind` без учётных данных (`bindDN` + `bindPassword`) | Ошибка конфигурации |
| `search` без `baseDN` | Ошибка конфигурации |
| `startTLS=true` с `ldaps://` | Ошибка конфигурации (несовместимо) |
