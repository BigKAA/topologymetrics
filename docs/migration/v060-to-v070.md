*[Русская версия](v060-to-v070.ru.md)*

# Migration from v0.6.0 to v0.7.0

Go SDK migration guide for the v0.7.0 release.

> This release affects **Go SDK only**. Java, Python, and C# SDKs remain at v0.5.0.

## What Changed

Three new methods on `DepHealth` allow dynamic endpoint management at runtime:

| Method | Description |
| --- | --- |
| `AddEndpoint` | Add a monitored endpoint after `Start()` |
| `RemoveEndpoint` | Remove an endpoint (cancels goroutine, deletes metrics) |
| `UpdateEndpoint` | Atomically replace an endpoint with a new one |

A new sentinel error `ErrEndpointNotFound` is available for detecting
missing endpoints in `UpdateEndpoint` calls.

---

## Do I Need to Change My Code?

**No.** This is a fully backward-compatible release. All existing code
continues to work without modification.

---

## New Feature: Dynamic Endpoints

Prior to v0.7.0, all dependencies had to be registered upfront via
functional options in `dephealth.New()`. Once `Start()` was called, the
set of monitored endpoints was frozen.

Starting with v0.7.0, you can add, remove, and update endpoints on a
running `DepHealth` instance:

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth"
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/httpcheck"
)

// After dh.Start(ctx)...

// Add a new endpoint
err := dh.AddEndpoint("api-backend", dephealth.TypeHTTP, true,
    dephealth.Endpoint{Host: "backend-2.svc", Port: "8080"},
    httpcheck.New(),
)

// Remove an endpoint
err = dh.RemoveEndpoint("api-backend", "backend-2.svc", "8080")

// Replace an endpoint atomically
err = dh.UpdateEndpoint("api-backend", "backend-1.svc", "8080",
    dephealth.Endpoint{Host: "backend-3.svc", Port: "8080"},
    httpcheck.New(),
)
```

### Key Behaviors

- **Thread-safe:** all three methods can be called concurrently from
  multiple goroutines.
- **Idempotent:** `AddEndpoint` returns `nil` if the endpoint already
  exists. `RemoveEndpoint` returns `nil` if the endpoint is not found.
- **Global config inheritance:** dynamically added endpoints use the
  global check interval and timeout configured in `New()`.
- **Metrics lifecycle:** `RemoveEndpoint` and `UpdateEndpoint` delete
  all Prometheus metrics for the old endpoint (health, latency, status,
  status_detail).

### Error Handling

```go
import "errors"

err := dh.UpdateEndpoint("api", "old-host", "8080", newEp, checker)
if errors.Is(err, dephealth.ErrEndpointNotFound) {
    // old endpoint does not exist — use AddEndpoint instead
}
if errors.Is(err, dephealth.ErrNotStarted) {
    // scheduler not started or already stopped
}
```

---

## Locking Improvement

`Health()` and `HealthDetails()` now hold the mutex for the entire
iteration, making them safe to call concurrently with dynamic endpoint
mutations. This is an internal implementation detail with no API changes.
