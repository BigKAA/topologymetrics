*[English version](v070-to-v080.md)*

# Миграция с v0.7.0 на v0.8.0

Руководство по миграции Go SDK на версию v0.8.0.

> Этот релиз затрагивает **все SDK**. Go SDK обновляется с v0.7.0 до v0.8.0.
> Java, Python и C# SDK обновляются с v0.6.0 до v0.8.0
> (см. [v0.6.0 → v0.8.0](v060-to-v080.ru.md)).

## Что изменилось

Новый LDAP-чекер с полной поддержкой протокола:

| Возможность | Описание |
| --- | --- |
| Методы проверки | `anonymous_bind`, `simple_bind`, `root_dse` (по умолчанию), `search` |
| Протоколы | `ldap://` (порт 389), `ldaps://` (порт 636), StartTLS |
| TLS-опции | `startTLS`, `tlsSkipVerify` |
| Режим пула | Принимает существующее `*ldap.Conn` для проверок |

---

## Нужно ли менять код?

**Нет.** Это полностью обратно совместимый релиз. Весь существующий код
продолжает работать без изменений.

---

## Новая возможность: LDAP-чекер

### Базовое использование

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth"
    _ "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
)

dh, _ := dephealth.New("my-service", "my-team",
    dephealth.LDAP("directory",
        dephealth.FromURL("ldap://ldap.svc:389"),
        dephealth.Critical(true),
    ),
)
```

### Методы проверки

```go
// Анонимная привязка
dephealth.LDAP("ldap",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("anonymous_bind"),
)

// Простая привязка с учётными данными
dephealth.LDAP("ad",
    dephealth.FromURL("ldaps://ad.corp:636"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("simple_bind"),
    dephealth.WithLDAPBindDN("cn=monitor,dc=corp,dc=com"),
    dephealth.WithLDAPBindPassword("secret"),
)

// Запрос RootDSE (по умолчанию)
dephealth.LDAP("openldap",
    dephealth.FromURL("ldap://openldap.svc:389"),
    dephealth.Critical(false),
)

// Поиск
dephealth.LDAP("directory",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPCheckMethod("search"),
    dephealth.WithLDAPBaseDN("dc=example,dc=com"),
    dephealth.WithLDAPSearchFilter("(objectClass=organizationalUnit)"),
    dephealth.WithLDAPSearchScope("one"),
)
```

### StartTLS

```go
dephealth.LDAP("ldap-starttls",
    dephealth.FromURL("ldap://ldap.svc:389"),
    dephealth.Critical(true),
    dephealth.WithLDAPStartTLS(true),
    dephealth.WithLDAPTLSSkipVerify(true), // опционально: пропустить проверку сертификата
)
```

### Режим пула

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
    ldaplib "github.com/go-ldap/ldap/v3"
)

conn, _ := ldaplib.DialURL("ldap://ldap.svc:389")
checker := ldapcheck.New(ldapcheck.WithConn(conn))
```

### Выборочный импорт

Импортируйте только LDAP-чекер для уменьшения размера бинарника:

```go
import _ "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/ldapcheck"
```

### Классификация ошибок

| Условие | Статус | Детализация |
| --- | --- | --- |
| Проверка прошла успешно | `ok` | `ok` |
| LDAP код 49 (Invalid Credentials) | `auth_error` | `auth_error` |
| LDAP код 50 (Insufficient Access Rights) | `auth_error` | `auth_error` |
| Ошибка TLS/StartTLS | `tls_error` | `tls_error` |
| Соединение отклонено | `connection_error` | `connection_refused` |
| Ошибка DNS-разрешения | `dns_error` | `dns_error` |
| Тайм-аут | `timeout` | `timeout` |
| Сервер недоступен/занят | `unhealthy` | `unhealthy` |

### Валидация конфигурации

| Условие | Ошибка |
| --- | --- |
| `simple_bind` без `bindDN` + `bindPassword` | Ошибка конфигурации |
| `search` без `baseDN` | Ошибка конфигурации |
| `startTLS=true` с `ldaps://` | Ошибка конфигурации (несовместимо) |
