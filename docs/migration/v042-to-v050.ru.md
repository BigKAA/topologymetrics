*[English version](v042-to-v050.md)*

# Миграция с v0.4.x на v0.5.0

Кросс-SDK руководство по миграции на релиз v0.5.0.

## Ломающее изменение: обязательный параметр `group`

v0.5.0 добавляет **обязательный параметр `group`** во все конструкторы SDK. Параметр
`group` обозначает логическую группу сервиса (команда, подсистема, проект) и позволяет
dephealth-ui группировать сервисы по логической принадлежности, а не по физическому
расположению (namespace Kubernetes).

Если `group` не указан ни в вызове API, ни в переменной окружения `DEPHEALTH_GROUP`,
SDK **откажется запускаться** с понятным сообщением об ошибке.

---

## Шаги миграции по SDK

### Go

```go
// v0.4.x
dh, err := dephealth.New("order-api",
    dephealth.Postgres("postgres-main", ...),
)

// v0.5.0
dh, err := dephealth.New("order-api", "billing-team",
    dephealth.Postgres("postgres-main", ...),
)
```

### Java (программный API)

```java
// v0.4.x
DepHealth dh = DepHealth.builder("order-api", meterRegistry)

// v0.5.0
DepHealth dh = DepHealth.builder("order-api", "billing-team", meterRegistry)
```

### Java (Spring Boot YAML)

```yaml
# v0.4.x
dephealth:
  name: order-api
  dependencies: ...

# v0.5.0
dephealth:
  name: order-api
  group: billing-team
  dependencies: ...
```

### Python

```python
# v0.4.x
dh = DependencyHealth("order-api",
    postgres_check("postgres-main", ...),
)

# v0.5.0
dh = DependencyHealth("order-api", "billing-team",
    postgres_check("postgres-main", ...),
)
```

### C\#

```csharp
// v0.4.x
var dh = DepHealthMonitor.CreateBuilder("order-api")

// v0.5.0
var dh = DepHealthMonitor.CreateBuilder("order-api", "billing-team")
```

---

## Переменная окружения

Добавьте `DEPHEALTH_GROUP` в конфигурацию деплоя. Приоритет такой же,
как у `DEPHEALTH_NAME`: аргумент API > переменная окружения.

```bash
DEPHEALTH_NAME=order-api
DEPHEALTH_GROUP=billing-team
```

Если `group` не указан ни в вызове API, ни в переменной окружения, SDK откажется
запускаться с понятным сообщением об ошибке.

---

## Изменение формата метрик

Все метрики теперь содержат метку `group`:

```text
# v0.4.x
app_dependency_health{name="order-api",dependency="postgres-main",type="postgres",host="pg.svc",port="5432",critical="yes"} 1

# v0.5.0
app_dependency_health{name="order-api",group="billing-team",dependency="postgres-main",type="postgres",host="pg.svc",port="5432",critical="yes"} 1
```

Порядок меток: `name`, `group`, `dependency`, `type`, `host`, `port`, `critical`, `[custom]`.

---

## Влияние на PromQL-запросы

Если ваши PromQL-запросы используют конструкцию `by()`, может потребоваться
добавить `group`:

```promql
# v0.4.x
sum by (name, dependency) (app_dependency_health)

# v0.5.0 — добавьте group при необходимости
sum by (name, group, dependency) (app_dependency_health)
```

Существующие запросы **без** конструкции `by()` продолжат работать — метка `group`
является просто дополнительной меткой.

---

## Правила валидации

Значение `group` следует тем же правилам, что и `name`:

| Правило | Значение |
| --- | --- |
| Формат | `[a-z][a-z0-9-]*` |
| Длина | 1-63 символов |
| Первый символ | строчная латинская буква |

---

## Деплой в Kubernetes

Добавьте `DEPHEALTH_GROUP` в Helm values или манифесты Kubernetes:

```yaml
env:
  - name: DEPHEALTH_GROUP
    value: "billing-team"
```
