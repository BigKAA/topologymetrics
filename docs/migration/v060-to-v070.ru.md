*[English version](v060-to-v070.md)*

# Миграция с v0.6.0 на v0.7.0

Руководство по миграции Go SDK на версию v0.7.0.

> Этот релиз затрагивает **только Go SDK**. Java, Python и C# SDK остаются на v0.5.0.

## Что изменилось

Три новых метода `DepHealth` позволяют динамически управлять эндпоинтами
в рантайме:

| Метод | Описание |
| --- | --- |
| `AddEndpoint` | Добавить мониторируемый эндпоинт после `Start()` |
| `RemoveEndpoint` | Удалить эндпоинт (отменяет горутину, удаляет метрики) |
| `UpdateEndpoint` | Атомарно заменить эндпоинт новым |

Новая сигнальная ошибка `ErrEndpointNotFound` позволяет обнаружить
отсутствующий эндпоинт при вызове `UpdateEndpoint`.

---

## Нужно ли менять код?

**Нет.** Это полностью обратно совместимый релиз. Весь существующий код
продолжает работать без изменений.

---

## Новая возможность: динамические эндпоинты

До v0.7.0 все зависимости регистрировались заранее через функциональные
опции в `dephealth.New()`. После вызова `Start()` набор мониторируемых
эндпоинтов был зафиксирован.

Начиная с v0.7.0, можно добавлять, удалять и обновлять эндпоинты на
работающем экземпляре `DepHealth`:

```go
import (
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth"
    "github.com/BigKAA/topologymetrics/sdk-go/dephealth/checks/httpcheck"
)

// После dh.Start(ctx)...

// Добавить новый эндпоинт
err := dh.AddEndpoint("api-backend", dephealth.TypeHTTP, true,
    dephealth.Endpoint{Host: "backend-2.svc", Port: "8080"},
    httpcheck.New(),
)

// Удалить эндпоинт
err = dh.RemoveEndpoint("api-backend", "backend-2.svc", "8080")

// Заменить эндпоинт атомарно
err = dh.UpdateEndpoint("api-backend", "backend-1.svc", "8080",
    dephealth.Endpoint{Host: "backend-3.svc", Port: "8080"},
    httpcheck.New(),
)
```

### Ключевые особенности

- **Потокобезопасность:** все три метода можно вызывать конкурентно из
  нескольких горутин.
- **Идемпотентность:** `AddEndpoint` возвращает `nil`, если эндпоинт уже
  существует. `RemoveEndpoint` возвращает `nil`, если эндпоинт не найден.
- **Наследование глобальной конфигурации:** динамически добавленные
  эндпоинты используют глобальный интервал и тайм-аут, настроенные в `New()`.
- **Жизненный цикл метрик:** `RemoveEndpoint` и `UpdateEndpoint` удаляют
  все метрики Prometheus для старого эндпоинта (health, latency, status,
  status_detail).

### Обработка ошибок

```go
import "errors"

err := dh.UpdateEndpoint("api", "old-host", "8080", newEp, checker)
if errors.Is(err, dephealth.ErrEndpointNotFound) {
    // старый эндпоинт не существует — используйте AddEndpoint
}
if errors.Is(err, dephealth.ErrNotStarted) {
    // планировщик не запущен или уже остановлен
}
```

---

## Улучшение блокировок

`Health()` и `HealthDetails()` теперь удерживают мьютекс на протяжении
всей итерации, что делает их безопасными для конкурентного вызова вместе
с динамическими мутациями эндпоинтов. Это внутренняя деталь реализации
без изменений в API.
