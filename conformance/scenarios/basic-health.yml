name: "basic-health"
description: "Все endpoint-ы доступны — все метрики = 1"

checks:
  - type: metric_exists
    metric: app_dependency_health

  - type: metric_exists
    metric: app_dependency_latency_seconds

  - type: help_text
    metric: app_dependency_health
    expected: "Health status of a dependency (1 = healthy, 0 = unhealthy)"

  - type: help_text
    metric: app_dependency_latency_seconds
    expected: "Latency of dependency health check in seconds"

  - type: required_labels
    metric: app_dependency_health

  - type: health_values

  - type: histogram_buckets

  - type: label_values
    metric: app_dependency_health

  # --- Status / Detail metrics ---

  - type: metric_exists
    metric: app_dependency_status

  - type: metric_exists
    metric: app_dependency_status_detail

  - type: help_text
    metric: app_dependency_status
    expected: "Category of the last check result"

  - type: help_text
    metric: app_dependency_status_detail
    expected: "Detailed reason of the last check result"

  - type: required_labels
    metric: app_dependency_status

  - type: required_labels
    metric: app_dependency_status_detail

  - type: status_enum_completeness

  - type: status_health_consistency

  - type: detail_value_always_one

  - type: detail_valid_values

  - type: detail_status_mapping

  - type: expected_status
    endpoints:
      - dependency: postgres-primary
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        status: ok
      - dependency: postgres-replica
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        status: ok
      - dependency: redis-cache
        host: redis.dephealth-conformance.svc
        port: 6379
        status: ok
      - dependency: rabbitmq
        host: rabbitmq.dephealth-conformance.svc
        port: 5672
        status: ok
      - dependency: kafka-main
        host: kafka.dephealth-conformance.svc
        port: 9092
        status: ok
      - dependency: http-service
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok
      - dependency: http-auth-bearer
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok
      - dependency: http-auth-basic
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok
      - dependency: http-auth-header
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok
      - dependency: http-auth-wrong
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok
      - dependency: grpc-service
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        status: ok
      - dependency: grpc-auth-bearer
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        status: ok
      - dependency: ldap-rootdse
        host: ldap.dephealth-conformance.svc
        port: 3389
        status: ok
      - dependency: ldap-bind
        host: ldap.dephealth-conformance.svc
        port: 3389
        status: ok
      - dependency: ldap-search
        host: ldap.dephealth-conformance.svc
        port: 3389
        status: ok
      - dependency: ldap-invalid-auth
        host: ldap.dephealth-conformance.svc
        port: 3389
        status: auth_error

  - type: expected_detail
    endpoints:
      - dependency: postgres-primary
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        detail: ok
      - dependency: postgres-replica
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        detail: ok
      - dependency: redis-cache
        host: redis.dephealth-conformance.svc
        port: 6379
        detail: ok
      - dependency: rabbitmq
        host: rabbitmq.dephealth-conformance.svc
        port: 5672
        detail: ok
      - dependency: kafka-main
        host: kafka.dephealth-conformance.svc
        port: 9092
        detail: ok
      - dependency: http-service
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok
      - dependency: http-auth-bearer
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok
      - dependency: http-auth-basic
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok
      - dependency: http-auth-header
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok
      - dependency: http-auth-wrong
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok
      - dependency: grpc-service
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        detail: ok
      - dependency: grpc-auth-bearer
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        detail: ok
      - dependency: ldap-rootdse
        host: ldap.dephealth-conformance.svc
        port: 3389
        detail: ok
      - dependency: ldap-bind
        host: ldap.dephealth-conformance.svc
        port: 3389
        detail: ok
      - dependency: ldap-search
        host: ldap.dephealth-conformance.svc
        port: 3389
        detail: ok
      - dependency: ldap-invalid-auth
        host: ldap.dephealth-conformance.svc
        port: 3389
        detail: auth_error

  # --- Health metric dependencies ---

  - type: expected_dependencies
    dependencies:
      - dependency: postgres-primary
        type: postgres
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        name: conformance-service
        critical: "yes"
        value: 1
      - dependency: postgres-replica
        type: postgres
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: redis-cache
        type: redis
        host: redis.dephealth-conformance.svc
        port: 6379
        name: conformance-service
        critical: "yes"
        value: 1
      - dependency: rabbitmq
        type: amqp
        host: rabbitmq.dephealth-conformance.svc
        port: 5672
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: kafka-main
        type: kafka
        host: kafka.dephealth-conformance.svc
        port: 9092
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: http-service
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: http-auth-bearer
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: http-auth-basic
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: http-auth-header
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: http-auth-wrong
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: grpc-service
        type: grpc
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: grpc-auth-bearer
        type: grpc
        host: grpc-stub.dephealth-conformance.svc
        port: 9090
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: ldap-rootdse
        type: ldap
        host: ldap.dephealth-conformance.svc
        port: 3389
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: ldap-bind
        type: ldap
        host: ldap.dephealth-conformance.svc
        port: 3389
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: ldap-search
        type: ldap
        host: ldap.dephealth-conformance.svc
        port: 3389
        name: conformance-service
        critical: "no"
        value: 1
      - dependency: ldap-invalid-auth
        type: ldap
        host: ldap.dephealth-conformance.svc
        port: 3389
        name: conformance-service
        critical: "no"
        value: 0
