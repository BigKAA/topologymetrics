name: "auth-http-bearer"
description: >
  HTTP Bearer token authentication.
  Covers plan scenarios 1 (bearer success), 4 (401 no auth), 5 (403 wrong token).
  Enables bearer auth on HTTP stub, verifies:
  - http-auth-bearer (correct token) is healthy
  - http-service (no auth) gets 401 → auth_error
  - http-auth-wrong (wrong token) gets 403 → auth_error

pre_actions:
  - type: http_request
    method: PUT
    url: "http://http-stub.dephealth-conformance.svc:8080/admin/auth/bearer?token=test-token-123"
  - type: wait
    seconds: 30

checks:
  - type: status_health_consistency

  # Correct bearer token → healthy
  - type: expected_dependencies
    dependencies:
      - dependency: http-auth-bearer
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 1

  - type: expected_status
    endpoints:
      - dependency: http-auth-bearer
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: ok

  - type: expected_detail
    endpoints:
      - dependency: http-auth-bearer
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: ok

  # No auth → 401 → auth_error
  - type: expected_dependencies
    dependencies:
      - dependency: http-service
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 0

  - type: expected_status
    endpoints:
      - dependency: http-service
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: auth_error

  - type: expected_detail
    endpoints:
      - dependency: http-service
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: auth_error

  # Wrong token → 403 → auth_error
  - type: expected_dependencies
    dependencies:
      - dependency: http-auth-wrong
        type: http
        host: http-stub.dephealth-conformance.svc
        port: 8080
        name: conformance-service
        critical: "no"
        value: 0

  - type: expected_status
    endpoints:
      - dependency: http-auth-wrong
        host: http-stub.dephealth-conformance.svc
        port: 8080
        status: auth_error

  - type: expected_detail
    endpoints:
      - dependency: http-auth-wrong
        host: http-stub.dephealth-conformance.svc
        port: 8080
        detail: auth_error

post_actions:
  - type: http_request
    method: DELETE
    url: "http://http-stub.dephealth-conformance.svc:8080/admin/auth"
