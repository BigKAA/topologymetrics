name: "partial-failure"
description: "Реплика PostgreSQL недоступна — primary = 1, replica = 0"

pre_actions:
  - type: scale
    kind: statefulset
    name: postgres-replica
    replicas: 0
  - type: wait
    seconds: 30

checks:
  - type: status_health_consistency

  - type: expected_status
    endpoints:
      - dependency: postgres-primary
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        status: ok
      - dependency: postgres-replica
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        status: connection_error

  - type: expected_detail
    endpoints:
      - dependency: postgres-primary
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        detail: ok
      - dependency: postgres-replica
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        detail: connection_refused

  - type: expected_dependencies
    dependencies:
      - dependency: postgres-primary
        type: postgres
        host: postgres-primary.dephealth-conformance.svc
        port: 5432
        name: conformance-service
        critical: "yes"
        value: 1
      - dependency: postgres-replica
        type: postgres
        host: postgres-replica.dephealth-conformance.svc
        port: 5432
        name: conformance-service
        critical: "no"
        value: 0

post_actions:
  - type: scale
    kind: statefulset
    name: postgres-replica
    replicas: 1
